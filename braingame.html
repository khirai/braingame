<!DOCTYPE html>
<!--
 Partly using code for Csound pnacl interactive example
 by  V Lazzarini
-->
<html>
  <head>
	<title>Braingame client</title>
	<meta content="text/html; charset=utf-8" http-equiv="content-type">
	<meta content="Tarmo Johannes" id="author">
    <style></style>
    
   <script type="text/javascript" src="csound.js"></script> 
   <script src="ws-functions.js"></script> <!-- websocket functions -->
   
   <script type="text/javascript">
   // csound functions (code by Victor Lazzarini)
   var orchval, selection;

    // functions called by csound.js
    function moduleDidLoad() {

		document.getElementById('files').addEventListener('change', handleFileSelect, false);
    }

    function attachListeners() {
       document.getElementById('playButton').addEventListener('click', csound.Play);
       document.getElementById('pauseButton').addEventListener('click',csound.Pause);
       document.getElementById('loadButton').addEventListener('click', loadFile);
       document.getElementById('compileButton1').addEventListener('click', compileOrc1);
       document.getElementById('compileButton2').addEventListener('click', compileOrc2);
       document.getElementById('code').addEventListener('blur',changeOrchestra);
       document.getElementById('code').addEventListener('select',selectOrchestra);
       orchval = getOrchestraElement().value;
    }
   
    var count = 0;
    function handleMessage(message) {
        var element = document.getElementById('outputtext');
        element.value += message.data;
        element.scrollTop = 99999; // focus on bottom
        count += 1;
        if(count == 1000) {
           element.value = ' ';
           count = 0;
        }
    }
    
    // event handlers for the html page
    function getOrchestraElement() {
      return document.getElementById('code');
    }

    function compileOrc1() {
       csound.CompileOrc(orchval); 
    }

    function compileOrc2() {
       orchval = selection;
       csound.CompileOrc(orchval);
    }

   function changeOrchestra() {    
       orchval = getOrchestraElement().value;
    }

   function getText(elem) {
       if(elem.tagName === "TEXTAREA" ||
         (elem.tagName === "INPUT" && elem.type === "text")) {
           return elem.value.substring(elem.selectionStart,
                                       elem.selectionEnd);
        }
        return null;
    }

    function selectOrchestra() {
        selection = getText(document.activeElement);  
    }
  
  var fname = '';
  var objectURL;
  function handleFileSelect(evt) {
    var files = evt.target.files; 
    var f = files[0];
    objectURL = window.webkitURL.createObjectURL(f);
    fname = f.name;
    document.getElementById('loadButton').innerText = 'load to ./local/' + fname;
  }

   function loadFile(){
    if(fname != ''){
     csound.CopyUrlToLocal(objectURL, fname);
     document.getElementById('loadButton').innerText = './local/' + fname +
     ' loaded' ;
    }
   }
   
   // UI and other websocket functions
   
	function send2server(messageType, content) { // type: csound / message /
		var messageString = messageType + "*" + document.myform.name.value + "*" + content;
		console.log(messageString);
		doSend(messageString);
		
	}
	function code2server() {
		var code = document.myform.code;
		if (code.selectionStart==code.selectionEnd) // nothing selected - take the whole orchestra
			alert("Nothing selected!");
		else {
			var selected = code.value.substring(code.selectionStart,code.selectionEnd);
			send2server("csound",selected); 
		}
	}

	

	window.onload = function(){
		//var connectButton = document.getElementById("connectButton");
		//document.myform.sendButton.disabled = true;

		var name = localStorage.getItem("brain-client-name");
		if (name)  { // if not set, generate an uuid for it
			console.log("Sored name: ", name);
			document.myform.name.value = name;
		} 
		
		
		doConnect(); // init websocket on start; suppose the server is ready
	};

   </script>
  </head>
  <body>
  <h1>Braingame client</h1>
  <form name="myform">
  Your name: <input type="text" id="name" value="Tarmo" onchange='localStorage.setItem("brain-client-name",this.value);'></input><br>
	<button type="button" id="playButton">Start Engine</button>
  <button type="button" id="pauseButton">Pause Engine</button> </p>
  Code:<br>
  <p> 
  <textarea class="code" id="code" cols="80" rows="16">
; press "Compile All" to compile this code, 
; if Csound is running you will hear white noise.
; This is an edit box, you can change the code
; and compile again with the buttons below.

schedule 1,0,1

instr 1
 a1 rand 0.5
 out a1
endin
  </textarea>

  <br>
  <button type="button" id="compileButton1">Compile All</button>
  <button type="button" id="compileButton2">Compile Selection</button> 
  <button type="button" id="sendButton" onclick='code2server();'>Send Selection to server</button> 
  <p>
  <input type="file" id="files" name="file" /> 
  <button type="button" id="loadButton">load to ./local</button>
  </p>
  
  Message to others (not displayed on big screen)<input type="text" id="message" value="message"></input>
  <button  type="button" id="sendMessage" onclick='send2server("message",document.myform.message.value);'>Send</button>
  <br>
  Message to display (like "Hello" "Please stop" etc)<input type="text" id="comment" value="comment"></input>
	<button  type="button" id="sendMessage" onclick='send2server("comment",document.myform.comment.value);'>Send</button>	

	<br>
  
  Server address: <input value="ws://localhost:10010/ws" id="url" type="text"><br>
    <button type="button" id="connectButton" onclick="doConnect();">Connect</button>
    <br>
    Messages from WS server and Csound:<br>
    <p><textarea id="outputtext" rows="8" cols="80" readonly></textarea> </p>
	</form>
	
	<!--pNaCl csound module-->
  <div id="engine"></div>
	
 </body>
</html>
