<!DOCTYPE html>
<!--
 Partly using code for Csound pnacl interactive example
 by  V Lazzarini
-->
<html>
  <head>
	<title>Braingame client</title>
	<meta content="text/html; charset=utf-8" http-equiv="content-type">
	<meta content="Tarmo Johannes" id="author">
    <style></style>
    
   <script type="text/javascript" src="csound.js"></script> 
   <script src="ws-functions.js"></script> <!-- websocket functions -->
   
   <script type="text/javascript">
   // csound functions (code by Victor Lazzarini)
   var orchval, selection;

    // functions called by csound.js
    function moduleDidLoad() {

		document.getElementById('files').addEventListener('change', handleFileSelect, false);
    }

    function attachListeners() {
       document.getElementById('playButton').addEventListener('click', csound.Play);
       document.getElementById('pauseButton').addEventListener('click',csound.Pause);
       document.getElementById('loadButton').addEventListener('click', loadFile);
       document.getElementById('compileButton1').addEventListener('click', compileOrc1);
       document.getElementById('compileButton2').addEventListener('click', compileOrc2);
       document.getElementById('code').addEventListener('blur',changeOrchestra);
       document.getElementById('code').addEventListener('select',selectOrchestra);
       orchval = getOrchestraElement().value;
    }
   
    var count = 0;
    function handleMessage(message) {
        var element = document.getElementById('outputtext');
        element.value += message.data;
        element.scrollTop = 99999; // focus on bottom
        count += 1;
        if(count == 1000) {
           element.value = ' ';
           count = 0;
        }
    }
    
    // event handlers for the html page
    function getOrchestraElement() {
      return document.getElementById('code');
    }

    function compileOrc1() {
       csound.CompileOrc(orchval); 
    }

    function compileOrc2() {
       orchval = selection;
       csound.CompileOrc(orchval);
    }

   function changeOrchestra() {    
       orchval = getOrchestraElement().value;
    }

   function getText(elem) {
       if(elem.tagName === "TEXTAREA" ||
         (elem.tagName === "INPUT" && elem.type === "text")) {
           return elem.value.substring(elem.selectionStart,
                                       elem.selectionEnd);
        }
        return null;
    }

    function selectOrchestra() {
        selection = getText(document.activeElement);  
    }
  
  var fname = '';
  var objectURL;
  function handleFileSelect(evt) {
    var files = evt.target.files; 
    var f = files[0];
    objectURL = window.webkitURL.createObjectURL(f);
    fname = f.name;
    document.getElementById('loadButton').innerText = 'load to ./local/' + fname;
  }

   function loadFile(){
    if(fname != ''){
     csound.CopyUrlToLocal(objectURL, fname);
     document.getElementById('loadButton').innerText = './local/' + fname +
     ' loaded' ;
    }
   }
   
   // UI and other websocket functions
   
	function send2server(messageType, content) { // type: csound / message /
		var messageString = messageType + "@" + document.myform.name.value + "@" + content;
		console.log(messageString);
		doSend(messageString);
		
	}
	function code2server() {
		var code = document.myform.code;
		if (code.selectionStart==code.selectionEnd) // nothing selected - take the whole orchestra
			alert("Nothing selected!");
		else {
			var selected = code.value.substring(code.selectionStart,code.selectionEnd);
			send2server("csound",selected); 
		}
	}

	

	window.onload = function(){
		//var connectButton = document.getElementById("connectButton");
		//document.myform.sendButton.disabled = true;
		//suppose localStorage works
		var name = localStorage.getItem("brain-client-name");
		if (name)  { // if not set, generate an uuid for it
			console.log("Stored name: ", name);
			document.myform.name.value = name;
		} 
		
		
		doConnect(); // init websocket on start; suppose the server is ready
	};
	
	function onMessage(evt)
	{	
		var message = evt.data + "\n";
		writeToScreen("Message from server: " + message);
		var messageParts = message.split("@");
		
		if (messageParts[0]=="message") { // message from other player
			var chatArea = document.getElementById("chat");
			chatArea.value += messageParts[1];
			chatArea.scrollTop = chatArea.scrollHeight;
		}
		
		
		if (messageParts[0]=="csound") { // code from other players
			
			var commandsArea = document.getElementById("command");
			commandsArea.value += messageParts[1] + ":" + messageParts[2] + "\n";
			commandsArea.scrollTop = commandsArea.scrollHeight;
		}
		
		if (messageParts[0]=="sensor") { // code from other players
			var sensorArea = document.getElementById("sensors");
			sensorArea.value += messageParts[1] + ":" + messageParts[2];
			sensorArea.scrollTop = sensorArea.scrollHeight;
		}
		
		//TODO: if message from peers // sensor values
	}

   </script>
  </head>
  <body>
  <h1>Braingame client</h1>
  <form name="myform">
  Your name: <input type="text" id="name" value="Tarmo" onchange='localStorage.setItem("brain-client-name",this.value);'></input><br>
	<button type="button" id="playButton">Start Engine</button>
  <button type="button" id="pauseButton">Pause Engine</button> </p>
  Code:<br>
  <p> 
  <textarea class="code" id="code" cols="80" rows="16">
; load your own csd, if you need

;CHANNELS:

; the challels are: 1)  brainsensors (values scaled to 0..1, updated in every second - USE PORT): attention1, attention2, attention3; HighBt ta - hb1 , hb2, hb3; low beta - lb1,lb2,lb3 ; - everything scaled to 0..1
;raw data (around -1000...1000, sent 512 times per second), must check, rhough; USE LIMIT!
; skin conductance: (scaled to 0..1) - skin1, skin2 - not TESTED YET!


schedule  "emulate",0, -1 ; mimics the sensors. comment out for performance! 
instr emulate 
	katn1 = 0.5 + jspline:k(0.5,0.1,5)
	khb1 = 0.5 + jspline:k(0.5,0.1,5)
	klb1 = 0.5 + jspline:k(0.5,0.1,5)
	kraw1 jspline 1000,1,50 ; may change pretty quickly
	chnset kraw1, "raw1"
	

	chnset 0.5 + jspline:k(0.4,0.1,1),"skin1"
	
	if (metro(1)==1) then ; the sensors send these values in every second
		chnset katn1, "attention1"
		chnset khb1, "hb1"
		chnset klb1, "lb1"
	endif
endin

; demo instrument:
gkLevelTarmo init 1 ; re-evaluate thes constants to change sound! 
gkPanTarmo init 0.5
gkBaseFreq init 400
; schedule "tarmo",0,-1 ; turn on
; schedule -nstrnum("tarmo"),0,0 ; turn off
instr tarmo ; FM
	kattention chnget "attention1" ; 0..1
	krawValue chnget "raw1" ; anything, between -60000 and 60000
	kfreq init 400
	if (abs(krawValue)<1000) then ; ignore big changes. or limit(kRawValue,-1000,1000)
		 kmod = (krawValue+1000)/1000 + 1 ; to tremble around 2.0
	endif
	kmod limit kmod, 0, 5
	
	klowBeta chnget "lb1" ; 0..1
	kmod += klowBeta
	kmod port kmod,0.1
	kindex = 1+klowBeta*10
	kindex port kindex,0.2
	
	kskin port chnget:k("skin1"),0.1
	kenv2 lfo 1-kskin, 1+10*(1-kskin),1 ; to give some pulsation
	
	kfreq = gkBaseFreq+kattention*200
	kfreq += kmod*8
	kfreq port kfreq,0.25

	aenv linenr 0.01,0.1,3,0.001 ; all envelopes should be with release (madsr, linenr etc)!
	asig foscil aenv, kfreq, 1,kmod, kindex, -1 
	apulse = asig*kenv2
	asig = 0.8*(asig+apulse)*port(gkLevelTarmo,0.05)
	aL, aR pan2 asig, gkPanTarmo
	outs aL, aR

endin

  </textarea>

  <br>
  <button type="button" id="compileButton1">Compile All</button>
  <button type="button" id="compileButton2">Compile Selection</button> 
  <button type="button" id="sendButton" onclick='code2server();'>Send Selection to server</button> 
  <p>
  <input type="file" id="files" name="file" /> 
  <button type="button" id="loadButton">load to ./local</button>
  </p>
  Commands of other players:<br>
  <textarea class="code" id="command" cols="80" rows="4">

  </textarea>
  <br>
  Messages from others:<br>
  <textarea class="code" id="chat" cols="80" rows="4">
  </textarea>
  <br>
  Sensors:<br>
  <textarea class="code" id="sensors" cols="80" rows="4">
  </textarea><br>
  <br>
  Message to others (not displayed on big screen)<input type="text" id="message" value="message"></input>
  <button  type="button" id="sendMessage" onclick='send2server("message",document.myform.message.value);'>Send</button>
  <br><br>
  Message to display (like "Hello" "Please stop" etc)<input type="text" id="comment" value="comment"></input>
	<button  type="button" id="sendMessage" onclick='send2server("comment",document.myform.comment.value);'>Send</button>	

	<br><br>
  
  Server address: <input value="ws://localhost:8080/ws" id="url" type="text"><br>
    <button type="button" id="connectButton" onclick="doConnect();">Connect</button>
    <br>
    Messages from WS server and Csound:<br>
    <p><textarea id="outputtext" rows="8" cols="80" readonly></textarea> </p>
	</form>
	
	<!--pNaCl csound module-->
  <div id="engine"></div>
	
 </body>
</html>
